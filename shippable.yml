language: node_js

node_js:
  - 0.10.24

jdk:
   - openjdk7
   
# For xunit-file module to put results in shippable folder
env:
  - XUNIT_FILE=shippable/testresults/result.xml

services:
  - postgres

build:
#  pre_ci:
#    - which docker
#    - which docker-compose
  pre_ci_boot:
    image_name: drydock/u14gol
    image_tag: prod
    pull: true
    options: "-v /opt/docker/docker-compose:/usr/bin/docker-compose"
  ci:
  #  - apt-get update
  #  - echo $JAVA_HOME
    - java -version
    - mkdir -p shippable/testresults
  #  - mkdir -p shippable/codecoverage
  #  - psql -c 'CREATE DATABASE app_test;' -U postgres
    - which docker
    - "curl -L https://github.com/docker/compose/releases/download/1.8.1/docker-compose-`uname -s`-`uname -m`  > /usr/local/bin/docker-compose"
    - chmod +x /usr/local/bin/docker-compose
    - which docker-compose
  #  - npm install
   # - npm test

# Generate coverage report with istanbul
  on_success:
    #  - psql -c 'create database if not exists test;' -U postgres
    - ./node_modules/.bin/istanbul cover ./node_modules/.bin/_mocha -- --ui=bdd --reporter=xunit-file
    - ./node_modules/.bin/istanbul report cobertura --dir shippable/codecoverage/
 # on_failure:
    #  - psql -c 'create database if not exists test;' -U postgres
 #   - ./node_modules/.bin/istanbul cover ./node_modules/.bin/_mocha -- --ui=bdd --reporter=xunit-file
 #   - ./node_modules/.bin/istanbul report cobertura --dir shippable/codecoverage/
