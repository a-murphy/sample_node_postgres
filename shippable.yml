language: node_js

node_js:
  - 0.10.24
   
# For xunit-file module to put results in shippable folder
env:
  - XUNIT_FILE=shippable/testresults/result.xml

services:
  - postgres

build:
  pre_ci_boot:
    image_name: drydock/u14nod
    image_tag: prod
    pull: true
    options: -v $SHIPPABLE_BUILD_DIR

  ci:
    - docker run --rm --volumes-from $SHIPPABLE_CONTAINER_NAME drydock/u14jav:prod ls $SHIPPABLE_BUILD_DIR
    
    - mkdir -p shippable/testresults
    - mkdir -p shippable/codecoverage
    - psql -c 'CREATE DATABASE app_test;' -U postgres
    - ls
 
# Generate coverage report with istanbul
  on_success:
    #  - psql -c 'create database if not exists test;' -U postgres
    - ./node_modules/.bin/istanbul cover ./node_modules/.bin/_mocha -- --ui=bdd --reporter=xunit-file
    - ./node_modules/.bin/istanbul report cobertura --dir shippable/codecoverage/
 # on_failure:
    #  - psql -c 'create database if not exists test;' -U postgres
 #   - ./node_modules/.bin/istanbul cover ./node_modules/.bin/_mocha -- --ui=bdd --reporter=xunit-file
 #   - ./node_modules/.bin/istanbul report cobertura --dir shippable/codecoverage/
