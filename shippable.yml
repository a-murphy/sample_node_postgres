language: node_js

# Services used by app
services:
  - postgres

node_js:
  - 0.10.25

# For xunit-file module to put results in shippable folder
env:
  global:
    - XUNIT_FILE=shippable/testresults/result.xml
    #- COMMITTER="$(git --no-pager show -s --format="%an" $COMMIT)"
    #- MESSAGE="$(git log --format=%B -n 1 $COMMIT)"
    - DOCKER_TAG=dockertag

# Postgres binds to 127.0.0.1 by default and is started on boot. Default username is "postgres" with no password
# Create a DB as part of before script to use it
# Make folders for the reports, and create the SQL db
build:
  ci:
    - ssh-agent bash -c 'ssh-add /tmp/ssh/01_deploy; npm install' 
   # - mkdir -p shippable/testresults
  #  - mkdir -p shippable/codecoverage
  #  - psql -c 'CREATE DATABASE app_test;' -U postgres
  #  - npm install
#    - npm test
# Generate coverage report with istanbul
  #post_ci:
    #  - psql -c 'create database if not exists test;' -U postgres
  #  - ./node_modules/.bin/istanbul cover ./node_modules/.bin/_mocha -- --ui=bdd --reporter=xunit-file
  #  - ./node_modules/.bin/istanbul report cobertura --dir shippable/codecoverage/

integrations:
  notifications:
    - integrationName: "Start"
      type: webhook
      payload:
        - commit=$COMMIT
        - dockerTag=["${DOCKER_TAG}"]
        - message=$MESSAGE
        - committer=$COMMITTER
      on_success: never
      on_start: always
