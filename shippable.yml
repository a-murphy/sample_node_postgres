language: node_js

node_js:
  - 0.10.24
   
# For xunit-file module to put results in shippable folder
env:
  - XUNIT_FILE=shippable/testresults/result.xml

build:
  ci:
    - apt-get install -y wget ca-certificates
    - echo "================= Installing Postgres 9.5 ==================="
    - echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list
    - wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
    - apt-get update
    - apt-get install -y postgresql-9.5 postgresql-server-dev-9.5
    - mkdir /etc/ssl/private-copy
    - mv /etc/ssl/private/* /etc/ssl/private-copy/
    - rm -r /etc/ssl/private
    - mv /etc/ssl/private-copy /etc/ssl/private
    - chmod -R 0700 /etc/ssl/private
    - chown -R postgres /etc/ssl/private
    - su -c \"$service_cmd > /dev/null 2>&1 &
    - mkdir -p shippable/testresults
    - mkdir -p shippable/codecoverage
    - psql -c 'CREATE DATABASE app_test;' -U postgres
    - npm install
    - npm test
    - su -c "sudo -u postgres /usr/lib/postgresql/$SHIPPABLE_POSTGRES_VERSION/bin/postgres -c config_file=/etc/postgresql/9.5/main/postgresql.conf > /dev/null 2>&1 &"

# Generate coverage report with istanbul
  on_success:
    - psql -c 'create database if not exists test;' -U postgres
    - ./node_modules/.bin/istanbul cover ./node_modules/.bin/_mocha -- --ui=bdd --reporter=xunit-file
    - ./node_modules/.bin/istanbul report cobertura --dir shippable/codecoverage/
  on_failure:
    - psql -c 'create database if not exists test;' -U postgres
    - ./node_modules/.bin/istanbul cover ./node_modules/.bin/_mocha -- --ui=bdd --reporter=xunit-file
    - ./node_modules/.bin/istanbul report cobertura --dir shippable/codecoverage/
